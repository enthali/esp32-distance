{"created": "2025-11-12T12:22:49.527172", "current_version": "", "project": "ESP32 Distance Sensor", "versions": {"": {"created": "2025-11-12T12:22:49.527154", "creator": {"program": "sphinx_needs", "version": "6.1.0"}, "needs": {"SPEC_CFG_JSON_BULK_1": {"acceptance_criteria": "", "api_signature": "", "arch": {}, "avatar": "", "closed_at": "", "completion": null, "component": "", "constraints": [], "constraints_error": null, "constraints_passed": true, "constraints_results": {}, "content": "**Description:** Configuration manager provides bulk JSON operations for efficient configuration management. These functions process all configuration fields in atomic operations.\n\n**Design Principle:** Bulk JSON API is the primary interface for multi-field configuration operations. Individual field access remains available for specific use cases.\n\n**Function 1: Schema Access**\n\n.. code-block:: c\n\n   /**\n    * @brief Get embedded JSON schema for dynamic UI generation\n    * @param[out] schema_json Pointer to embedded schema string (no free() needed)\n    * @return ESP_OK on success, ESP_ERR_NOT_FOUND if schema not embedded\n    */\n   esp_err_t config_get_schema_json(char **schema_json);\n\n**Function 2: Bulk Configuration Read**\n\n.. code-block:: c\n\n   /**\n    * @brief Read all configuration values as structured JSON array\n    * @param[out] config_json Allocated JSON string (caller must free())\n    * @return ESP_OK on success, ESP_ERR_NO_MEM on allocation failure\n    */\n   esp_err_t config_get_all_as_json(char **config_json);\n\n**Implementation Strategy:**\n- Read JSON schema to enumerate all defined fields\n- For each field, call appropriate ``config_get_*()`` function based on schema type\n- Build JSON array with {key, type, value} objects for all current values\n- Handle password masking (never expose sensitive fields)\n\n**Function 3: Bulk Configuration Write**\n\n.. code-block:: c\n\n   /**\n    * @brief Update configuration from structured JSON array\n    * @param[in] config_json JSON array with {key, type, value} objects\n    * @return ESP_OK on success, ESP_ERR_INVALID_ARG on validation failure\n    */\n   esp_err_t config_set_all_from_json(const char *config_json);\n\n**Implementation Strategy:**\n- Parse input JSON array to extract {key, type, value} objects\n- For each object, validate ``key`` exists in schema and ``type`` matches\n- Call appropriate ``config_set_*_no_commit()`` function based on ``type``\n- Single ``config_commit()`` call for atomic update\n- Return error if any field validation fails\n\n**Error Handling:**\n- Unknown ``key`` fields: ignored (forward compatibility)\n- Invalid ``type`` values: return ESP_ERR_INVALID_ARG\n- Type mismatch (``type`` vs schema): return ESP_ERR_INVALID_ARG\n- Range violations: return ESP_ERR_INVALID_ARG\n- NVS errors: propagate ESP_ERR_NVS_* codes\n- Malformed JSON: return ESP_ERR_INVALID_ARG\n\n**JSON Format Example:**\n\n.. code-block:: json\n\n   [\n     {\n       \"key\": \"wifi_ssid\",\n       \"type\": \"string\",\n       \"value\": \"MyNetwork\"\n     },\n     {\n       \"key\": \"wifi_pass\",\n       \"type\": \"string\",\n       \"value\": \"password123\"\n     },\n     {\n       \"key\": \"ap_ssid\",\n       \"type\": \"string\",\n       \"value\": \"MyDevice-AP\"\n     },\n     {\n       \"key\": \"led_count\",\n       \"type\": \"integer\",\n       \"value\": 50\n     },\n     {\n       \"key\": \"led_bright\",\n       \"type\": \"integer\",\n       \"value\": 128\n     },\n     {\n       \"key\": \"device_name\",\n       \"type\": \"string\",\n       \"value\": \"MyDevice\"\n     }\n   ]\n\n**Design Properties:**\n- **No hardcoded fields** in any client component\n- **Schema-driven completeness** (all fields included automatically)\n- **Future-proof** (new schema fields work without client changes)\n- **Atomic updates** (all changes committed together)\n- **Type safety** (schema validates types before NVS storage)\n\n**Primary Use Cases:**\n- Web server HTTP endpoints: Use bulk APIs for GET/POST operations\n- Factory reset: Load default values with ``config_set_all_from_json()``\n- Configuration export/import: System backup and restore\n- CLI commands: Batch configuration from command line\n- Remote management: Configuration updates from network protocols", "created_at": "", "docname": "12_design/spec_config_manager_json", "doctype": ".rst", "duration": null, "external_css": "external_link", "external_url": null, "has_dead_links": false, "has_forbidden_dead_links": false, "header_file": "", "id": "SPEC_CFG_JSON_BULK_1", "id_prefix": "", "is_external": false, "is_import": false, "is_modified": false, "jinja_content": false, "layout": null, "lineno": 492, "links": ["REQ_CFG_JSON_12", "REQ_CFG_JSON_13"], "links_back": ["SPEC_CFG_WEB_FLOW_1", "SPEC_CFG_WEB_MAPPING_1"], "max_amount": "", "max_content_lines": "", "modifications": 0, "parameters": "", "params": "", "parent_need": null, "parent_needs": [], "parent_needs_back": [], "parts": {}, "post_content": null, "post_template": null, "pre_content": null, "pre_template": null, "prefix": "", "priority": "", "query": "", "rationale": "", "returns": "", "section_name": "Web Interface Design", "sections": ["Web Interface Design", "JSON-Based Configuration Manager Design"], "service": "", "signature": null, "specific": "", "status": "approved", "style": null, "tags": ["api", "json", "bulk-operations"], "template": null, "title": "Bulk JSON Configuration API", "type": "spec", "type_name": "Design Specification", "updated_at": "", "url": "", "url_postfix": "", "user": ""}}, "needs_amount": 1}}}